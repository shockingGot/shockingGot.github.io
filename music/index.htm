<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>球场电单车</title>

    <style>
        body {
            height: 100vh;
            margin: 0px;
            background-color: black;
            overflow:hidden;
        }

        .box{
            display: flex;
            justify-content:center;
            align-items: center;
            height: 100vh;

        }
        
        .perspective {
            perspective: 500px; /* 调整透视效果的深度 */
            background-color1: #333333;
        }
        
        .trapezoid {
            width: 400px;            /* 矩形的宽度 */
            height: 400px;          /* 矩形的高度 */
            background-color1: #3498db; /* 矩形的颜色 */
            transform: rotateX(-10deg) rotateY(55deg) scaleY(0.9) translateZ(-10px); /* 透视效果 */
            position: relative;
            overflow:hidden;
          
        }
        
        #lyrics {
                    font-size: 1.2em;
                    line-height: 1.5em;
                    padding: 10px;
                    border: 0px solid #ccc;
                    background-color1: #333;
          	   color:#666;
                    text-shadow: 0 0 2px #222, 0 0 2px #222;
                }

	#lyrics p{
		opacity:0.6;
	}
                #lyrics .highlight {
                    color: #fafafa;
                    font-size: 1.4em;
		    opacity:0.8;
                }
                .highlight2{
                    color: #dadada;
                    font-size: 1.3em;
                }
        
        .circle-image {
            width: 300px;             /* 设置宽度 */
            height: 300px;            /* 设置高度 */
            border-radius: 50%;       /* 设置为50%以形成圆形 */
            object-fit: cover;        /* 确保图像的填充方式合适 */
        }

    </style>
</head>

<body>
  <div style="max-width:480px;min-width1:100vw;height:100vh;border:0px solid #222;position:relative;margin:auto auto;overflow:hidden;">
    <div style="position:absolute;width:100%;z-index:3;padding:16px;text-align:center;color:#efefef;font-size:1.2em;opacity:0.65;font-weight:bold;" id="appTitle">- 球场电单车 -</div>
    <div class="box" style="position:absolute;z-index:2;width:100%;height:100%;border:0px solid red;background1:red;">
       <!-- 歌词显示 -->
       <div class="perspective">
           <div id="lyrics" class="trapezoid"></div>
       </div>
    </div>
  
 

    <div style="position:absolute;z-index:1;right:10px;top:80px;">
        <img id="appImg" src="球场电单车长版2.png" class="circle-image">
    </div>

    <div style="position:absolute;z-index:20;width:100%;height:100%;display: flex;justify-content:center;align-items: center;border:0px solid red;opacity:0.45;font-weight:bold;color:white;font-size:60px;cursor:pointer;" onclick="this.style.display='none'">
	播放▶
    </div>

  </div>

   <div style="position:fixed;z-index:10;bottom:10px;text-align:center;width:100vw;color:white;">
        <!-- 用于选择本地文件 -->
        <label for="fileInput" class="custom-button">选择mp3文件</label>
        <input type="file" id="fileInput" accept="audio/mp3" style="display:none;">

        <label for="lrcInput" class="custom-button">选择lrc文件</label>
        <input type="file" id="lrcInput" accept=".lrc" style="display:none;">
	<br/>
        <!-- 音频播放控件 -->
        <audio id="audioPlayer" controls></audio>
   </div>

   

   <div id="appBG" style="opacity:0.25;top:0px;left:0px;position:absolute;z-index:0;width:100vw;height:100vh;background-image: url('球场电单车长版.png');filter: blur(6px);background-size: cover;">123</div>

    <script>
		
    
        // LRC歌词内容
                var lrcContent = '';
        
                // 解析LRC字幕并返回时间和歌词的数组
                function parseLRC(lrc) {
                    const lines = lrc.split('\n');
                    const lyrics = [];
        
                    lines.forEach(line => {
                        const match = line.match(/\[(\d+):(\d+)\.(\d+)\](.*)/);
                        if (match) {
                            const minutes = parseInt(match[1]);
                            const seconds = parseInt(match[2]);
                            const milliseconds = parseInt(match[3]);
                            const time = minutes * 60 + seconds + milliseconds / 1000;
                            const text = match[4].trim();
                            lyrics.push({ time, text });
                        }
                    });
                    return lyrics;
                }
        
                // 将解析后的歌词显示到页面上
                /*const lyricsArray = parseLRC(lrcContent);
                const lyricsDiv = document.getElementById('lyrics');
                
                lyricsArray.forEach(lyric => {
                    const p = document.createElement('p');
                    p.textContent = lyric.text;
	　 if(lyric.text == ''){
	    	p.innerHTML = '&nbsp;'
	    }
                    p.dataset.time = lyric.time;
                    lyricsDiv.appendChild(p);
                });*/

	var lyricsArray
	var lyricsDiv = document.getElementById('lyrics');

	function loadLRC(s){
		lyricsArray = parseLRC(s);
                	//var lyricsDiv = document.getElementById('lyrics');
                
                	lyricsArray.forEach(lyric => {
                   	 	var p = document.createElement('p');
                    		p.textContent = lyric.text;
	　 		if(lyric.text == ''){
	    			p.innerHTML = '&nbsp;'
	    		}
                    		p.dataset.time = lyric.time;
                    		lyricsDiv.appendChild(p);
               	 	});
	}
	//loadLRC(lrcContent)

        
                // 当音频播放时，同步歌词显示
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.addEventListener('timeupdate', () => {
                    const currentTime = audioPlayer.currentTime;
        
                    lyricsArray.forEach((lyric, index) => {
                        const nextLyric = lyricsArray[index + 1];
                        const lyricElement = lyricsDiv.querySelector(`p[data-time='${lyric.time}']`);
        
                        // 高亮当前时间的歌词
                        if (currentTime >= lyric.time && (!nextLyric || currentTime < nextLyric.time)) {
                            // 移除之前的高亮
                            const highlighted = lyricsDiv.querySelector('.highlight');
                            if (highlighted) highlighted.classList.remove('highlight');
                            
                            // 高亮当前歌词
                            lyricElement.classList.add('highlight');
        

                            // 自动滚动歌词区域
                            lyricsDiv.scrollTop = lyricElement.offsetTop - lyricsDiv.offsetTop - lyricsDiv.clientHeight / 2;
                        }
                    });
                });
        
                // 选择本地MP3文件并播放
                document.getElementById('fileInput').addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const fileURL = URL.createObjectURL(file);
                        audioPlayer.src = fileURL;
                        audioPlayer.play();
                    }
                });

		audioPlayer.src = '球场电单车长版.mp3'

	var played = false
	document.body.addEventListener('click', function() {
	    if(played){return}
   
            audioPlayer.play().catch(error => {
                console.error("播放失败:", error);
            });
	    played = true
        });

    </script>

	<script>

        const lrcPadding = `
        [00:00.01]
        [00:00.10]
        [00:00.20]
        [00:00.30]
        [00:00.40]
        [00:00.50]
	`


        document.getElementById('lrcInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const content = e.target.result;
                    //document.getElementById('fileContent').textContent = content;
					loadLRC(lrcPadding + content)
                };
                
                reader.onerror = function(e) {
                    console.error("读取文件时发生错误:", e);
                };
                
                reader.readAsText(file, 'UTF-8');
            }
        });
        
        
        
        
        function getQueryParams() {
			var queryParams = {};
			var queryString = window.location.search.substring(1); // 获取URL中的查询字符串部分
			var pairs = queryString.split("&"); // 将查询字符串分割成键值对数组

			for (var i = 0; i < pairs.length; i++) {
				var pair = pairs[i].split("="); // 将键值对分割成键和值
				queryParams[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || ''); // 解码键和值，并添加到对象中
			}

			return queryParams;
		}
		
		function initApp(){

			var params = getQueryParams();
			var songfolder = params['f']
			var songName = params['n']
			    
			document.title = songName;
			document.getElementById('appTitle').innerHTML = songName

			document.getElementById('appImg').src = songfolder + '/' + songName + '.png'
			document.getElementById('appBG').style.backgroundImage = "url('" + songfolder + "/" + songName + ".png')"
			
			audioPlayer.src = songfolder + '/' + songName + '.mp3'
			
			getLyric(songfolder,songName )
		}
		
		
		function getLyric(songfolder, songName){
			var xhr = new XMLHttpRequest();
			xhr.open('GET', songfolder + '/' + songName + '.txt', true);
			xhr.overrideMimeType('text/plain; charset=utf-8');
			console.log(songfolder + '/' + songName + '.txt')
			xhr.onreadystatechange = function () {
				if (xhr.readyState == 4 && xhr.status == 200) {
					var content = xhr.responseText;
					console.log(content); // 这里可以处理文件内容
					
					loadLRC(lrcPadding + content)
				}
			};
			xhr.send();
		
		}
		
		initApp()
    </script>
</body>

</html>
